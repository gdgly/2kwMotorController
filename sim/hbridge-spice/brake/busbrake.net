* Z:\home\odougs\storage\project\2kwMotorController\sim\hbridge-spice\brake\busbrake.asc
Vduty Vduty 0 PWL(0 0.98 {t_drive} 0.98 {t_drive + 0.1m} 0.3)
Vdir Vdir 0 0
Vmode Vmode 0 1
Vbrake Vbrake 0 0
M1 N002 N007 M+ M+ IPP100N08N3
M2 M+ N010 0 0 IPP100N08N3
M3 N002 N008 M- M- IPP100N08N3
M4 M- N011 0 0 IPP100N08N3
Vbattery Vbus N012 {Vbatt} Rser=2m
R§Motor M+ N009 1µ
XX1 Vduty Vdir Vbrake Vmode HO1 M+ LO1 HO2 M- LO2 gatedriver
Cbus Vbus 0 5mF Rser=5m IC={Vbatt}
Rsense Vbus N002 1µ
Rbrake Vbus N001 1 pwr=200
M5 N001 N003 0 0 IPP100N08N3
Vbus_dis N013 0 PWL(0 10 {t_drive} 10 {t_drive + 0.1m} 0)
E1 N003 0 N004 0 10
A1 0 0 N005 N006 0 0 N004 0 AND
V4 N006 0 PULSE(0 1 0 1n 1n 50e-6 50e-6)
M6 N012 N013 0 0 IPP100N08N3
A3 N014 0 0 0 0 0 N005 0 SCHMITT Vt={Vbatt+1} Vh=1
R1 N014 Vbus 800
C2 N014 0 100n
XX2 N009 M- NC_07 rad/s dc_motor_model
I1 rad/s 0 0.1
E2 krpm 0 rad/s 0 9.55e-3
R2 HO2 N008 100
R3 LO2 N011 100
R4 HO1 N007 100
D3 N007 HO1 MBR735
R5 LO1 N010 100
D1 N010 LO1 MBR735
D2 N011 LO2 MBR735
D4 N008 HO2 MBR735

* block symbol definitions
.subckt gatedriver DUTY DIR BRAKE MODE HO1 HS1 LO1 HO2 HS2 LO2
XU1 DUTY Vsawtooth N010 0 PWM LTC6752
VDD N010 0 5
V2 Vsawtooth 0 PULSE(0 1 0 {0.99/fs} {0.01/fs} 0 {1/fs})
A2 DIR 0 0 0 0 N001 0 0 BUF
A3 BRAKE 0 0 0 0 N002 0 0 BUF
A6 DIR N003 N005 N006 0 0 N004 0 AND
A8 BRAKE 0 0 0 0 N003 0 0 BUF
A9 MODE 0 0 0 0 N005 0 0 BUF
A10 PWM 0 0 0 0 N006 0 0 BUF
A11 DIR N008 MODE PWM 0 0 N007 0 AND
A13 BRAKE 0 0 0 0 N008 0 0 BUF
A16 0 BRAKE 0 PWM 0 0 N009 0 AND
A4 N004 N007 0 0 0 0 HO2_EN 0 OR
A5 0 N011 MODE N014 0 0 N013 0 AND
A21 DIR N018 0 N019 0 0 N016 0 AND
A23 BRAKE 0 0 0 0 N018 0 0 BUF
A25 PWM 0 0 0 0 N019 0 0 BUF
A26 N012 0 0 PWM 0 0 N015 0 AND
A27 DIR 0 0 0 0 N012 0 0 BUF
A7 DIR N022 MODE 0 0 0 N017 0 AND
A14 BRAKE 0 0 0 0 N022 0 0 BUF
A12 N009 N013 N016 N017 0 0 LO1_EN 0 OR
A18 0 BRAKE 0 PWM 0 0 N020 0 AND
A32 0 N023 MODE N024 0 0 N021 0 AND
A34 BRAKE 0 0 0 0 N023 0 0 BUF
A36 PWM 0 0 0 0 N024 0 0 BUF
R1 HO1_EN 0 1Meg
E1 HO1 HS1 HO1_EN 0 10V
A1 N001 N002 0 PWM 0 0 HO1_EN 0 AND
R2 HO2_EN 0 1Meg
E2 HO2 HS2 HO2_EN 0 10V
R3 LO1_EN 0 1Meg
E3 LO1 0 LO1_EN 0 10V
R4 LO2_EN 0 1Meg
E4 LO2 0 LO2_EN 0 10V
A19 N015 N020 N021 0 0 0 LO2_EN 0 OR
A20 BRAKE 0 0 0 0 N011 0 0 BUF
A24 PWM 0 0 0 0 N014 0 0 BUF
.param fs=20kHz
.ends gatedriver

.subckt dc_motor_model +DC -DC enc omega
Aenc N002 0 0 0 0 p 0 0 SCHMITT Vt=0.5 Vh=0.5 td=10n
Bp 0 N002 I=kenc*abs(v(omega))*(V(p)-0.5)
Cenc N002 0 1m
LM +DC N001 120µH
RM N001 emf {RM}
Bemf emf -DC V=k*V(omega)
B§Itorque 0 omega I=k*I(Bemf)
C_Jinertia omega 0 {J}
R_Bfriction omega 0 {1/B}
Benc N003 0 V=5*V(p)
B§I_load_torque_int omega 0 I=sgn(v(omega))*min(Tint,0.1*abs(v(omega)))
R1 enc N003 220
.param kenc=0.49
.param RM = 0.089
.param k = 0.0398
.param J = 0.001256
.param B = 0.0001
.param Tint = 0.05
.ends dc_motor_model

.model D D
.lib C:\users\odougs\My Documents\LTspiceXVII\lib\cmp\standard.dio
.model NMOS NMOS
.model PMOS PMOS
.lib C:\users\odougs\My Documents\LTspiceXVII\lib\cmp\standard.mos
.tran {t_drive + 0.1}
.param t_drive=0.1
.param Vbatt=48V
* Demonstration of regenerative braking effect when\nreducing duty cycle in sign-magnitude drive mode.\n \nIf Vbus_dis remains on, Vbattery will overcharge.\nIf Vbus_dis is turned off, but Rbrake is not utilized,\nVbus will become overcharged.
* Brake power: V(Vbus,N001)*I(Rbrake)
.lib LTC7.lib
.backanno
.end
